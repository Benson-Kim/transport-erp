// Enterprise Dashboard Database Schema
// PostgreSQL with Prisma ORM
// Version: 1.0.0

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres", "views"]
  binaryTargets   = ["native"]
  output          = "../src/app/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =============================================
// ENUMS
// =============================================

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  ACCOUNTANT
  OPERATOR
  VIEWER
}

enum ServiceStatus {
  DRAFT
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  INVOICED
  ARCHIVED
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  RESTORE
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
  COMPLETE
  CANCEL
  SEND_EMAIL
  GENERATE_DOCUMENT
  ARCHIVE
}

enum DocumentType {
  LOADING_ORDER
  INVOICE
  RECEIPT
  DELIVERY_NOTE
  CONTRACT
  OTHER
}

// =============================================
// AUTHENTICATION MODELS (NextAuth.js v5)
// =============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// =============================================
// CORE BUSINESS MODELS
// =============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  password      String? // Optional for OAuth users
  name          String
  role          UserRole  @default(VIEWER)
  avatar        String?
  phone         String?
  department    String?
  isActive      Boolean   @default(true)

  // Two-factor authentication
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String?

  // Metadata
  lastLoginAt       DateTime?
  lastLoginIp       String?
  passwordChangedAt DateTime?

  // Relations
  accounts         Account[]
  sessions         Session[]
  services         Service[]      @relation("ServiceCreator")
  assignedServices Service[]      @relation("ServiceAssignee")
  loadingOrders    LoadingOrder[]
  invoices         Invoice[]      @relation("InvoiceCreator")
  auditLogs        AuditLog[]
  notifications    Notification[]

  // Audit fields
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([email])
  @@index([role])
  @@index([deletedAt])
  @@map("users")
}

model Company {
  id             String  @id @default(cuid())
  code           String  @unique // Internal company code
  legalName      String
  tradeName      String?
  vatNumber      String  @unique // VAT/Tax ID
  registrationNo String? // Company registration number

  // Address
  addressLine1 String
  addressLine2 String?
  city         String
  state        String?
  postalCode   String
  country      String  @default("ES")

  // Contact
  phone   String
  fax     String?
  email   String
  website String?

  // Banking
  bankName    String?
  bankAccount String?
  swiftCode   String?
  iban        String?

  // Settings
  currency      String  @default("EUR")
  timezone      String  @default("Europe/Madrid")
  fiscalYearEnd String? // MM-DD format
  invoicePrefix String?
  logoUrl       String?

  // Metadata
  metadata Json? // Flexible field for additional data
  isActive Boolean @default(true)

  // Relations
  asClient   Client[]
  asSupplier Supplier[]

  // Audit fields
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([vatNumber])
  @@index([code])
  @@index([deletedAt])
  @@map("companies")
}

model Client {
  id         String  @id @default(cuid())
  clientCode String  @unique // Internal client code
  companyId  String? // Optional link to company

  // Basic Information
  name      String
  tradeName String?
  vatNumber String?

  // Addresses
  billingAddress  Json // { line1, line2, city, state, postalCode, country }
  shippingAddress Json? // Optional different shipping address

  // Contacts
  billingEmail  String
  trafficEmail  String? // For operational communications
  contactPerson String?
  contactPhone  String?
  contactMobile String?

  // Financial
  creditLimit  Decimal? @db.Decimal(10, 2)
  paymentTerms Int      @default(30) // Days
  discount     Decimal? @db.Decimal(5, 2) // Percentage

  // Settings
  currency      String  @default("EUR")
  language      String  @default("es")
  sendReminders Boolean @default(true)
  autoInvoice   Boolean @default(false)

  // Metadata
  notes    String?  @db.Text
  tags     String[] // For categorization
  metadata Json?
  isActive Boolean  @default(true)

  // Relations
  company   Company?        @relation(fields: [companyId], references: [id])
  services  Service[]
  contacts  ClientContact[]
  documents Document[]

  // Audit fields
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([clientCode])
  @@index([vatNumber])
  @@index([companyId])
  @@index([deletedAt])
  @@map("clients")
}

model ClientContact {
  id       String @id @default(cuid())
  clientId String

  name      String
  position  String?
  email     String
  phone     String?
  mobile    String?
  isPrimary Boolean @default(false)

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@map("client_contacts")
}

model Supplier {
  id           String  @id @default(cuid())
  supplierCode String  @unique // Internal supplier code
  companyId    String? // Optional link to company

  // Basic Information
  name      String
  tradeName String?
  vatNumber String?

  // Address
  addressLine1 String
  addressLine2 String?
  city         String
  state        String?
  postalCode   String
  country      String  @default("ES")

  // Contact
  email         String
  phone         String?
  fax           String?
  contactPerson String?
  contactMobile String?

  // Financial Settings
  irpfRate      Decimal? @db.Decimal(5, 2) // IRPF retention rate (Spain)
  vatRate       Decimal  @default(21.00) @db.Decimal(5, 2)
  paymentTerms  Int      @default(30) // Days
  paymentMethod String? // TRANSFER, CASH, CARD, etc.

  // Banking
  bankName    String?
  bankAccount String?
  swiftCode   String?
  iban        String?

  // Settings
  currency    String  @default("EUR")
  autoApprove Boolean @default(false)
  requirePO   Boolean @default(false) // Require purchase order

  // Metadata
  notes    String?  @db.Text
  tags     String[]
  metadata Json?
  isActive Boolean  @default(true)

  // Relations
  company   Company?   @relation(fields: [companyId], references: [id])
  services  Service[]
  invoices  Invoice[]
  documents Document[]

  // Audit fields
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([supplierCode])
  @@index([vatNumber])
  @@index([companyId])
  @@index([deletedAt])
  @@map("suppliers")
}

model Service {
  id            String   @id @default(cuid())
  serviceNumber String   @unique // AUTO-GENERATED: SRV-YYYY-NNNNN
  date          DateTime

  // Relations
  clientId     String
  supplierId   String
  createdById  String
  assignedToId String?

  // Service Details
  description  String  @db.Text
  reference    String? // Client reference number
  origin       String
  destination  String
  distance     Int? // in kilometers
  vehicleType  String?
  vehiclePlate String?
  driverName   String?

  // Financial
  costAmount       Decimal @db.Decimal(10, 2)
  costCurrency     String  @default("EUR")
  saleAmount       Decimal @db.Decimal(10, 2)
  saleCurrency     String  @default("EUR")
  margin           Decimal @db.Decimal(10, 2) // Calculated field
  marginPercentage Decimal @db.Decimal(5, 2) // Calculated field

  // VAT/Tax
  costVatRate   Decimal @default(21.00) @db.Decimal(5, 2)
  costVatAmount Decimal @db.Decimal(10, 2)
  saleVatRate   Decimal @default(21.00) @db.Decimal(5, 2)
  saleVatAmount Decimal @db.Decimal(10, 2)

  // Status
  status             ServiceStatus @default(DRAFT)
  completedAt        DateTime?
  cancelledAt        DateTime?
  cancellationReason String?
  archivedAt         DateTime?

  // Metadata
  notes         String?  @db.Text
  internalNotes String?  @db.Text // Not shown to clients
  attachments   String[] // File paths
  customFields  Json? // For flexible additional fields

  // Relations
  client        Client                 @relation(fields: [clientId], references: [id])
  supplier      Supplier               @relation(fields: [supplierId], references: [id])
  createdBy     User                   @relation("ServiceCreator", fields: [createdById], references: [id])
  assignedTo    User?                  @relation("ServiceAssignee", fields: [assignedToId], references: [id])
  loadingOrders ServiceLoadingOrder[]
  invoiceItems  InvoiceItem[]
  documents     Document[]
  statusHistory ServiceStatusHistory[]

  // Audit fields
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([serviceNumber])
  @@index([date])
  @@index([clientId])
  @@index([supplierId])
  @@index([status])
  @@index([deletedAt])
  @@index([date, status])
  @@map("services")
}

model ServiceStatusHistory {
  id         String         @id @default(cuid())
  serviceId  String
  fromStatus ServiceStatus?
  toStatus   ServiceStatus
  reason     String?
  changedBy  String
  changedAt  DateTime       @default(now())

  // Relations
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@map("service_status_history")
}

model LoadingOrder {
  id            String   @id @default(cuid())
  orderNumber   String   @unique // AUTO-GENERATED: LO-YYYY-NNNNN
  generatedAt   DateTime @default(now())
  generatedById String

  // Details
  clientId String? // Optional direct client link
  notes    String? @db.Text

  // PDF Storage
  pdfPath        String?
  pdfGeneratedAt DateTime?
  pdfSize        Int? // File size in bytes

  // Metadata
  metadata Json?

  // Relations
  generatedBy User                  @relation(fields: [generatedById], references: [id])
  services    ServiceLoadingOrder[]

  // Audit fields
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([orderNumber])
  @@index([generatedById])
  @@index([deletedAt])
  @@map("loading_orders")
}

model ServiceLoadingOrder {
  id             String @id @default(cuid())
  serviceId      String
  loadingOrderId String
  position       Int // Order position in the loading order

  // Relations
  service      Service      @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  loadingOrder LoadingOrder @relation(fields: [loadingOrderId], references: [id], onDelete: Cascade)

  @@unique([serviceId, loadingOrderId])
  @@index([serviceId])
  @@index([loadingOrderId])
  @@map("service_loading_orders")
}

model Invoice {
  id            String   @id @default(cuid())
  invoiceNumber String   @unique // AUTO-GENERATED: INV-YYYY-NNNNN
  invoiceDate   DateTime
  dueDate       DateTime

  // Relations
  supplierId  String
  createdById String

  // Financial
  subtotal    Decimal @db.Decimal(10, 2)
  taxAmount   Decimal @db.Decimal(10, 2)
  totalAmount Decimal @db.Decimal(10, 2)
  currency    String  @default("EUR")

  // Payment
  status           InvoiceStatus @default(DRAFT)
  paymentStatus    PaymentStatus @default(PENDING)
  paidAmount       Decimal       @default(0) @db.Decimal(10, 2)
  paidAt           DateTime?
  paymentMethod    String?
  paymentReference String?

  // IRPF (Spain specific)
  irpfRate   Decimal? @db.Decimal(5, 2)
  irpfAmount Decimal? @db.Decimal(10, 2)

  // Details
  description     String? @db.Text
  notes           String? @db.Text
  termsConditions String? @db.Text

  // PDF Storage
  pdfPath        String?
  pdfGeneratedAt DateTime?

  // Email Tracking
  sentAt         DateTime?
  sentTo         String?
  viewedAt       DateTime?
  reminderSentAt DateTime?

  // Metadata
  metadata Json?

  // Relations
  supplier  Supplier      @relation(fields: [supplierId], references: [id])
  createdBy User          @relation("InvoiceCreator", fields: [createdById], references: [id])
  items     InvoiceItem[]
  payments  Payment[]

  // Audit fields
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([invoiceNumber])
  @@index([supplierId])
  @@index([status])
  @@index([dueDate])
  @@index([deletedAt])
  @@map("invoices")
}

model InvoiceItem {
  id        String  @id @default(cuid())
  invoiceId String
  serviceId String? // Optional link to service

  // Item Details
  description String
  quantity    Decimal @db.Decimal(10, 2)
  unitPrice   Decimal @db.Decimal(10, 2)
  amount      Decimal @db.Decimal(10, 2)

  // Tax
  taxRate   Decimal @db.Decimal(5, 2)
  taxAmount Decimal @db.Decimal(10, 2)

  // Relations
  invoice Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  service Service? @relation(fields: [serviceId], references: [id])

  @@index([invoiceId])
  @@index([serviceId])
  @@map("invoice_items")
}

model Payment {
  id            String @id @default(cuid())
  paymentNumber String @unique // AUTO-GENERATED: PAY-YYYY-NNNNN
  invoiceId     String

  amount        Decimal  @db.Decimal(10, 2)
  currency      String   @default("EUR")
  paymentDate   DateTime
  paymentMethod String // TRANSFER, CASH, CARD, CHEQUE, etc.
  reference     String? // Bank reference

  status PaymentStatus @default(COMPLETED)

  notes       String? @db.Text
  receiptPath String? // PDF receipt path

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id])

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceId])
  @@index([paymentDate])
  @@map("payments")
}

model Document {
  id             String       @id @default(cuid())
  documentType   DocumentType
  documentNumber String? // Optional document number

  // Relations
  clientId   String?
  supplierId String?
  serviceId  String?

  // File Details
  fileName String
  filePath String
  fileSize Int // in bytes
  mimeType String

  // Metadata
  description String?
  tags        String[]
  metadata    Json?

  // Relations
  client   Client?   @relation(fields: [clientId], references: [id])
  supplier Supplier? @relation(fields: [supplierId], references: [id])
  service  Service?  @relation(fields: [serviceId], references: [id])

  // Audit fields
  uploadedBy String
  uploadedAt DateTime  @default(now())
  deletedAt  DateTime?

  @@index([clientId])
  @@index([supplierId])
  @@index([serviceId])
  @@index([documentType])
  @@index([deletedAt])
  @@map("documents")
}

// =============================================
// SYSTEM MODELS
// =============================================

model AuditLog {
  id        String      @id @default(cuid())
  userId    String? // Null for system actions
  action    AuditAction
  tableName String
  recordId  String

  // Change tracking
  oldValues Json? // Previous values
  newValues Json? // New values

  // Context
  ipAddress String?
  userAgent String?
  requestId String? // For request tracing

  // Metadata
  metadata Json? // Additional context

  // Relations
  user User? @relation(fields: [userId], references: [id])

  // Timestamp
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([tableName, recordId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model Notification {
  id     String @id @default(cuid())
  userId String

  title    String
  message  String @db.Text
  type     String // info, success, warning, error
  category String // system, invoice, service, etc.

  actionUrl   String? // Optional link to related item
  actionLabel String?

  isRead Boolean   @default(false)
  readAt DateTime?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Audit fields
  createdAt DateTime @default(now())

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

model SystemSetting {
  id          String  @id @default(cuid())
  key         String  @unique
  value       Json
  description String?
  isPublic    Boolean @default(false) // Can be exposed to client

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@map("system_settings")
}
